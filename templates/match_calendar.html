{% extends "base.html" %}

{% block title %}Week {{ week }} Calendar{% endblock %}

{% block content %}
<section class="card">
    <div class="card-header">
        <div>
            <h2 class="card-title">Book Match Time</h2>
            <p class="card-subtitle">Reserve a 30-minute slot between Monday and Friday to show when the room is in use.</p>
        </div>
        <a class="btn btn-secondary" href="{{ url_for('view_schedule', week=week) }}">Back to Week {{ week }}</a>
    </div>

    <div class="card-section match-calendar-summary">
        <div class="matchup-heading">
            <span class="player-name">{{ match.player1_name }}</span>
            <span class="vs-label">vs</span>
            <span class="player-name">{{ match.player2_name }}</span>
        </div>
        {% if current_entry %}
            <div class="chip chip-success">Booked: {{ current_entry.summary }}</div>
        {% else %}
            <div class="card-meta">No slot reserved yet.</div>
        {% endif %}
    </div>

    <div class="card-section">
    <p id="calendar-instructions" class="calendar-instructions">Click any open slot between 6:00 AM and 8:00 PM to reserve it for this matchup. You'll confirm the booking before it's saved.</p>
        <form method="post" id="calendar-book-form" class="calendar-book-form">
            <input type="hidden" name="action" value="book">
            <input type="hidden" name="weekday" id="booking-weekday">
            <input type="hidden" name="start_slot" id="booking-start">
        </form>
        {% if current_entry %}
            <form method="post" class="no-loading match-calendar-clear">
                <input type="hidden" name="action" value="clear">
                <button type="submit" class="btn btn-ghost">Clear Booking</button>
            </form>
        {% endif %}
    </div>

    <div class="card-section">
        <div class="calendar-legend">
            <span class="legend-item legend-item-open"><span class="legend-swatch"></span>Open slot</span>
            <span class="legend-item legend-item-booked"><span class="legend-swatch"></span>Booked slot</span>
            <span class="legend-item legend-item-current"><span class="legend-swatch"></span>This matchup</span>
        </div>
        <div class="calendar-wrapper">
            <table class="calendar-table" aria-describedby="calendar-instructions">
                <thead>
                    <tr>
                        <th>Time</th>
                        {% for label in weekday_labels %}
                            <th>{{ label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in calendar_rows %}
                        <tr>
                            <td class="calendar-time">{{ row.time_label }}</td>
                            {% for cell in row.cells %}
                                <td class="calendar-cell{% if not cell.occupied %} is-available{% endif %}{% if cell.occupied %} is-booked{% endif %}{% if cell.is_current %} is-current{% endif %}"
                                    data-weekday="{{ loop.index0 }}"
                                    data-slot="{{ row.slot }}"
                                    data-time-label="{{ row.time_label }}"
                                    data-end-label="{{ row.end_label }}"
                                    data-day-label="{{ weekday_labels[loop.index0] }}">
                                    {% if cell.starts %}
                                        <div class="calendar-event">
                                            <strong>{{ cell.entry.player1_name or 'TBD' }}</strong>
                                            <span class="vs-label">vs</span>
                                            <strong>{{ cell.entry.player2_name or 'TBD' }}</strong>
                                            <div class="calendar-event-time">{{ cell.entry.start_label }} - {{ cell.entry.end_label }}</div>
                                        </div>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<dialog id="booking-modal" class="calendar-modal" aria-labelledby="booking-modal-title">
    <div class="calendar-modal__content">
        <h3 id="booking-modal-title" class="calendar-modal__title">Confirm Booking</h3>
        <p id="booking-modal-details" class="calendar-modal__message">Reserve this slot?</p>
        <div class="calendar-modal__actions">
            <button type="button" class="btn btn-primary" id="booking-confirm">Confirm</button>
            <button type="button" class="btn btn-ghost" id="booking-cancel">Cancel</button>
        </div>
    </div>
</dialog>
{% endblock %}
